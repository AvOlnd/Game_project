import arcade
import math
import random

SCREEN_WIDTH = 800
SCREEN_HEIGHT = 600
SCREEN_TITLE = "Стрельба по мишеням"

PLAYER_SPEED = 5
BULLET_SPEED = 10
PLAYER_SCALE = 0.5
BULLET_SCALE = 0.2
TARGET_COUNT = 5


class Target(arcade.Sprite):
    def __init__(self, image, scale):
        super().__init__(image, scale)


class MyGame(arcade.Window):
    def __init__(self):
        super().__init__(SCREEN_WIDTH, SCREEN_HEIGHT, SCREEN_TITLE)

        self.player_sprite = None
        self.bullet_list = None
        self.target_list = None

        self.left_pressed = False
        self.right_pressed = False
        self.up_pressed = False
        self.down_pressed = False

        self.score = 0
        self.victory = False

        arcade.set_background_color(arcade.color.AMAZON)

    def setup(self):
        self.score = 0
        self.victory = False

        self.player_sprite = arcade.Sprite(
            ":resources:images/animated_characters/female_person/femalePerson_idle.png",
            PLAYER_SCALE
        )
        self.player_sprite.center_x = SCREEN_WIDTH // 2
        self.player_sprite.center_y = 50

        self.bullet_list = arcade.SpriteList()
        self.target_list = arcade.SpriteList()

        for _ in range(TARGET_COUNT):
            target = Target(":resources:images/items/coinGold.png", 0.5)
            target.center_x = random.randint(50, SCREEN_WIDTH - 50)
            target.center_y = random.randint(200, SCREEN_HEIGHT - 50)
            self.target_list.append(target)

    def on_draw(self):
        self.clear()

        self.player_sprite.draw()
        self.bullet_list.draw()
        self.target_list.draw()

        arcade.draw_text(f"Очки: {self.score}", 10, SCREEN_HEIGHT - 30,
                         arcade.color.WHITE, 24)
        arcade.draw_text(f"Мишеней: {len(self.target_list)}", 10,
                         SCREEN_HEIGHT - 60, arcade.color.WHITE, 18)
        arcade.draw_text("WASD - движение, ЛКМ - стрельба",
                         10, SCREEN_HEIGHT - 90, arcade.color.WHITE, 14)

        if self.victory:
            arcade.draw_text(
                "ПОБЕДА!\nНажми R для рестарта",
                SCREEN_WIDTH // 2,
                SCREEN_HEIGHT // 2,
                arcade.color.GOLD,
                32,
                anchor_x="center",
                anchor_y="center",
                align="center"
            )

    def on_update(self, delta_time):
        if self.victory:
            return

        self.player_sprite.change_x = 0
        self.player_sprite.change_y = 0

        if self.up_pressed:
            self.player_sprite.change_y = PLAYER_SPEED
        if self.down_pressed:
            self.player_sprite.change_y = -PLAYER_SPEED
        if self.left_pressed:
            self.player_sprite.change_x = -PLAYER_SPEED
        if self.right_pressed:
            self.player_sprite.change_x = PLAYER_SPEED

        self.player_sprite.update()
        self.bullet_list.update()

        for bullet in self.bullet_list:
            hit_list = arcade.check_for_collision_with_list(
                bullet, self.target_list
            )

            for target in hit_list:
                target.remove_from_sprite_lists()
                bullet.remove_from_sprite_lists()
                self.score += 10

        if len(self.target_list) == 0:
            self.victory = True

    def on_mouse_press(self, x, y, button, modifiers):
        if button == arcade.MOUSE_BUTTON_LEFT and not self.victory:
            bullet = arcade.Sprite(
                ":resources:images/space_shooter/laserBlue01.png",
                BULLET_SCALE
            )

            bullet.center_x = self.player_sprite.center_x
            bullet.center_y = self.player_sprite.center_y

            x_diff = x - bullet.center_x
            y_diff = y - bullet.center_y
            angle = math.atan2(y_diff, x_diff)

            bullet.change_x = math.cos(angle) * BULLET_SPEED
            bullet.change_y = math.sin(angle) * BULLET_SPEED
            bullet.angle = math.degrees(angle)

            self.bullet_list.append(bullet)

    def on_key_press(self, key, modifiers):
        if key == arcade.key.W:
            self.up_pressed = True
        elif key == arcade.key.S:
            self.down_pressed = True
        elif key == arcade.key.A:
            self.left_pressed = True
        elif key == arcade.key.D:
            self.right_pressed = True
        elif key == arcade.key.R:
            self.setup()
        elif key == arcade.key.ESCAPE:
            arcade.close_window()

    def on_key_release(self, key, modifiers):
        if key == arcade.key.W:
            self.up_pressed = False
        elif key == arcade.key.S:
            self.down_pressed = False
        elif key == arcade.key.A:
            self.left_pressed = False
        elif key == arcade.key.D:
            self.right_pressed = False


def main():
    window = MyGame()
    window.setup()
    arcade.run()


if __name__ == "__main__":
    main()
