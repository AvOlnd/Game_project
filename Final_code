import arcade
import random
import math
import json
import os


SCREEN_WIDTH = 1000
SCREEN_HEIGHT = 700
SCREEN_TITLE = "КОСМИЧЕСКИЙ ЗАЩИТНИК"
PLAYER_SPEED = 8
BULLET_SPEED = 12
MAX_BULLETS = 15
SHOOT_DELAY = 0.1
STAR_SPEED = 5  


class Particle:
    def __init__(self, x, y, vx, vy, size, color, life):
        self.x = x
        self.y = y
        self.vx = vx
        self.vy = vy
        self.size = size
        self.color = color
        self.life = life
        self.age = 0


    def update(self, delta_time):
        self.x += self.vx
        self.y += self.vy
        self.age += delta_time


    def is_alive(self):
        return self.age < self.life


    def draw(self):
        alpha = int(255 * (1 - self.age / self.life))
        arcade.draw_circle_filled(self.x, self.y, self.size, (*self.color, alpha))


class Asteroid:
    def __init__(self, x, y, size, speed_x, speed_y):
        self.x = x
        self.y = y
        self.size = size
        self.speed_x = speed_x
        self.speed_y = speed_y
        self.health = 2


    def update(self):
        self.x += self.speed_x
        self.y += self.speed_y


    def draw(self):
        arcade.draw_circle_filled(self.x, self.y, self.size, arcade.color.GRAY)
        arcade.draw_circle_outline(self.x, self.y, self.size, arcade.color.WHITE, 2)

    def collides_with(self, other_x, other_y, radius):
        dx = self.x - other_x
        dy = self.y - other_y
        return dx * dx + dy * dy < (self.size + radius) ** 2


class Bullet:
    def __init__(self, x, y, speed):
        self.x = x
        self.y = y
        self.speed = speed


    def update(self):
        self.y += self.speed


    def draw(self):
        left = self.x - 3
        right = self.x + 3
        bottom = self.y - 10
        top = self.y + 10
        arcade.draw_lrbt_rectangle_filled(left, right, bottom, top, arcade.color.YELLOW)
        arcade.draw_lrbt_rectangle_outline(left, right, bottom, top, arcade.color.ORANGE, 1)


class Star:
    def __init__(self, x, y, size, color, twinkle_speed, twinkle_offset):
        self.x = x
        self.y = y
        self.size = size
        self.color = color
        self.twinkle_speed = twinkle_speed
        self.twinkle_offset = twinkle_offset


    def draw(self, time):
        brightness = 0.5 + 0.5 * math.sin(time * self.twinkle_speed + self.twinkle_offset)
        alpha = int(150 + 105 * brightness)
        arcade.draw_circle_filled(self.x, self.y, self.size, (*self.color, alpha))


class SpaceDefender(arcade.Window):
    def __init__(self):
        super().__init__(SCREEN_WIDTH, SCREEN_HEIGHT, SCREEN_TITLE)
        self.game_state = "MENU"
        self.high_score = self.load_high_score()

        self.player_x = SCREEN_WIDTH // 2
        self.player_y = 100
        self.player_width = 50
        self.player_height = 35
        self.player_health = 100
        self.player_max_health = 100
        self.player_invulnerable = 0

        self.bullets = []
        self.asteroids = []
        self.particles = []
        self.stars = []

        self.score = 0
        self.level = 1
        self.game_time = 0
        self.asteroids_destroyed = 0

        self.shoot_timer = 0
        self.can_shoot = True

        self.left_pressed = False
        self.right_pressed = False
        self.space_pressed = False

        self.setup()


    def load_high_score(self):
        try:
            if os.path.exists("high_score.json"):
                with open("high_score.json", "r") as f:
                    data = json.load(f)
                    return data.get("high_score", 0)
        except Exception as e:
            print(f"Ошибка загрузки рекорда: {e}")
        return 0


    def save_high_score(self):
        if self.score > self.high_score:
            self.high_score = self.score
            try:
                with open("high_score.json", "w") as f:
                    json.dump({"high_score": self.high_score}, f)
            except Exception as e:
                print(f"Ошибка сохранения рекорда: {e}")


    def setup(self):
        self.stars = []
        for _ in range(200):
            star = Star(
                random.uniform(0, SCREEN_WIDTH),
                random.uniform(0, SCREEN_HEIGHT),
                random.uniform(1, 3),
                (255, 255, 255),
                random.uniform(1, 3),
                random.uniform(0, 6.28)
            )
            self.stars.append(star)
        arcade.set_background_color(arcade.color.BLACK)


    def start_game(self):
        self.game_state = "PLAYING"
        self.player_x = SCREEN_WIDTH // 2
        self.player_y = 100
        self.player_health = self.player_max_health
        self.player_invulnerable = 0

        self.bullets = []
        self.asteroids = []
        self.particles = []

        self.score = 0
        self.level = 1
        self.game_time = 0
        self.asteroids_destroyed = 0
        self.shoot_timer = 0
        self.can_shoot = True

        self.left_pressed = False
        self.right_pressed = False
        self.space_pressed = False


    def on_draw(self):
        self.clear()
        if self.game_state == "MENU":
            self.draw_menu()
        elif self.game_state == "PLAYING":
            self.draw_game()
        elif self.game_state == "GAME_OVER":
            self.draw_game_over()


    def on_update(self, delta_time):
        self.game_time += delta_time

        for star in self.stars:
            star.y -= STAR_SPEED
            if star.y < 0:
                star.y = SCREEN_HEIGHT
                star.x = random.uniform(0, SCREEN_WIDTH)

        if self.game_state == "PLAYING":
            self.update_game(delta_time)


    def draw_menu(self):
        for star in self.stars:
            star.draw(self.game_time)

        arcade.draw_text("КОСМИЧЕСКИЙ ЗАЩИТНИК",
                        SCREEN_WIDTH // 2, SCREEN_HEIGHT - 150,
                        arcade.color.CYAN, 48,
                        anchor_x="center",
                        font_name="Arial", bold=True)

        arcade.draw_text("Защищайте Землю от астероидов!",
                        SCREEN_WIDTH // 2, SCREEN_HEIGHT - 220,
                        arcade.color.YELLOW, 24,
                        anchor_x="center", font_name="Arial")

        arcade.draw_text(f"РЕКОРД: {self.high_score}",
                        SCREEN_WIDTH // 2, SCREEN_HEIGHT - 270,
                        arcade.color.GOLD, 28,
                        anchor_x="center", font_name="Arial", bold=True)

        controls = [
            "УПРАВЛЕНИЕ:",
            "← → - Движение влево/вправо",
            "ПРОБЕЛ - Стрельба",
            "ESC - Выход в меню"
        ]

        for i, text in enumerate(controls):
            arcade.draw_text(text,
                           SCREEN_WIDTH // 2, SCREEN_HEIGHT - 330 - i * 30,
                           arcade.color.WHITE, 18,
                           anchor_x="center", font_name="Arial")

        arcade.draw_lrbt_rectangle_filled(
            SCREEN_WIDTH // 2 - 100, SCREEN_WIDTH // 2 + 100, 150, 200, arcade.color.GREEN
        )
        arcade.draw_lrbt_rectangle_outline(
            SCREEN_WIDTH // 2 - 100, SCREEN_WIDTH // 2 + 100, 150, 200, arcade.color.WHITE, 2
        )
        arcade.draw_text("НАЧАТЬ ИГРУ", SCREEN_WIDTH // 2, 175,
                        arcade.color.WHITE, 20, anchor_x="center", anchor_y="center",
                        font_name="Arial", bold=True)

        arcade.draw_text("Нажмите на кнопку или пробел для начала",
                        SCREEN_WIDTH // 2, 120,
                        arcade.color.LIGHT_BLUE, 16,
                        anchor_x="center", font_name="Arial")


    def draw_game(self):
        for star in self.stars:
            star.draw(self.game_time)

        for particle in self.particles:
            particle.draw()

        for bullet in self.bullets:
            bullet.draw()

        for asteroid in self.asteroids:
            asteroid.draw()

        if self.player_invulnerable > 0 and (self.player_invulnerable // 3) % 2 == 0:
            color = arcade.color.CYAN
        else:
            color = arcade.color.BLUE

        points = [
            (self.player_x, self.player_y + self.player_height // 2),
            (self.player_x - self.player_width // 2, self.player_y - self.player_height // 2),
            (self.player_x + self.player_width // 2, self.player_y - self.player_height // 2)
        ]
        arcade.draw_polygon_filled(points, color)
        arcade.draw_polygon_outline(points, arcade.color.WHITE, 2)

        self.draw_ui()


    def draw_ui(self):
        health_width = 300 * (self.player_health / self.player_max_health)
        arcade.draw_lrbt_rectangle_filled(
            50, 350, SCREEN_HEIGHT - 42, SCREEN_HEIGHT - 17, arcade.color.DARK_RED
        )
        arcade.draw_lrbt_rectangle_filled(
            50, 50 + health_width, SCREEN_HEIGHT - 42, SCREEN_HEIGHT - 17, arcade.color.GREEN
        )
        arcade.draw_lrbt_rectangle_outline(
            50, 350, SCREEN_HEIGHT - 42, SCREEN_HEIGHT - 17, arcade.color.WHITE, 2
        )

        arcade.draw_text(f"ЗДОРОВЬЕ: {self.player_health}",
                        200, SCREEN_HEIGHT - 30,
                        arcade.color.WHITE, 14, anchor_x="center", anchor_y="center",
                        font_name="Arial", bold=True)

        arcade.draw_text(f"СЧЁТ: {self.score}",
                        SCREEN_WIDTH - 150, SCREEN_HEIGHT - 30,
                        arcade.color.WHITE, 20, anchor_x="center", anchor_y="center",
                        font_name="Arial", bold=True)

        arcade.draw_text(f"РЕКОРД: {self.high_score}",
                        SCREEN_WIDTH - 150, SCREEN_HEIGHT - 60,
                        arcade.color.GOLD, 16, anchor_x="center", anchor_y="center",
                        font_name="Arial", bold=True)

        arcade.draw_text(f"УРОВЕНЬ: {self.level}",
                        SCREEN_WIDTH // 2, SCREEN_HEIGHT - 30,
                        arcade.color.CYAN, 20, anchor_x="center", anchor_y="center",
                        font_name="Arial", bold=True)

        minutes = int(self.game_time) // 60
        seconds = int(self.game_time) % 60
        time_text = f"ВРЕМЯ: {minutes:02d}:{seconds:02d} | АСТЕРОИДОВ: {self.asteroids_destroyed}"
        arcade.draw_text(time_text,
                        SCREEN_WIDTH // 2, SCREEN_HEIGHT - 60,
                        arcade.color.WHITE, 14, anchor_x="center", anchor_y="center",
                        font_name="Arial")

        if self.player_health < 30 and (int(self.game_time * 5) % 2 == 0):
            arcade.draw_text("ОПАСНО! НИЗКОЕ ЗДОРОВЬЕ!",
                           SCREEN_WIDTH // 2, SCREEN_HEIGHT // 2,
                           arcade.color.RED, 24, anchor_x="center", anchor_y="center",
                           font_name="Arial", bold=True)


    def draw_game_over(self):
        for star in self.stars:
            star.draw(self.game_time)

        arcade.draw_lrbt_rectangle_filled(0, SCREEN_WIDTH, 0, SCREEN_HEIGHT, (0, 0, 0, 128))

        for i in range(30):
            x = random.uniform(0, SCREEN_WIDTH)
            y = random.uniform(0, SCREEN_HEIGHT)
            size = random.uniform(20, 40)
            arcade.draw_text("★", x, y,
                           arcade.color.CYAN, size,
                           anchor_x="center", anchor_y="center")

        arcade.draw_text("ИГРА ОКОНЧЕНА",
                        SCREEN_WIDTH // 2, SCREEN_HEIGHT - 180,
                        arcade.color.RED, 48, anchor_x="center",
                        font_name="Arial", bold=True)

        arcade.draw_text(f"ВАШ СЧЁТ: {self.score}",
                        SCREEN_WIDTH // 2, SCREEN_HEIGHT - 250,
                        arcade.color.WHITE, 36, anchor_x="center",
                        font_name="Arial")

        if self.score > self.high_score:
            arcade.draw_text("НОВЫЙ РЕКОРД!",
                           SCREEN_WIDTH // 2, SCREEN_HEIGHT - 300,
                           arcade.color.GOLD, 32, anchor_x="center",
                           font_name="Arial", bold=True)

        stats = [
            f"Уничтожено астероидов: {self.asteroids_destroyed}",
            f"Прожито времени: {int(self.game_time)} сек",
            f"Достигнутый уровень: {self.level}"
        ]

        for i, stat in enumerate(stats):
            arcade.draw_text(stat,
                           SCREEN_WIDTH // 2, SCREEN_HEIGHT - 350 - i * 30,
                           arcade.color.LIGHT_BLUE, 18, anchor_x="center",
                           font_name="Arial")

        arcade.draw_lrbt_rectangle_filled(
            SCREEN_WIDTH // 2 - 100, SCREEN_WIDTH // 2 + 100, 150, 200, arcade.color.GREEN
        )
        arcade.draw_lrbt_rectangle_outline(
            SCREEN_WIDTH // 2 - 100, SCREEN_WIDTH // 2 + 100, 150, 200, arcade.color.WHITE, 2
        )
        arcade.draw_text("НОВАЯ ИГРА", SCREEN_WIDTH // 2, 175,
                        arcade.color.WHITE, 20, anchor_x="center", anchor_y="center",
                        font_name="Arial", bold=True)

        arcade.draw_lrbt_rectangle_filled(
            SCREEN_WIDTH // 2 - 100, SCREEN_WIDTH // 2 + 100, 100, 150, arcade.color.BLUE
        )
        arcade.draw_lrbt_rectangle_outline(
            SCREEN_WIDTH // 2 - 100, SCREEN_WIDTH // 2 + 100, 100, 150, arcade.color.WHITE, 2
        )
        arcade.draw_text("В МЕНЮ", SCREEN_WIDTH // 2, 125,
                        arcade.color.WHITE, 16, anchor_x="center", anchor_y="center",
                        font_name="Arial")

        arcade.draw_text("Нажмите R для новой игры или ESC для выхода в меню",
                        SCREEN_WIDTH // 2, 70,
                        arcade.color.LIGHT_BLUE, 16, anchor_x="center",
                        font_name="Arial")


    def update_game(self, delta_time):
        if self.left_pressed and self.player_x > self.player_width // 2:
            self.player_x -= PLAYER_SPEED
        if self.right_pressed and self.player_x < SCREEN_WIDTH - self.player_width // 2:
            self.player_x += PLAYER_SPEED

        if self.player_invulnerable > 0:
            self.player_invulnerable -= 1

        if self.space_pressed and self.can_shoot and len(self.bullets) < MAX_BULLETS:
            bullet = Bullet(self.player_x, self.player_y + self.player_height // 2, BULLET_SPEED)
            self.bullets.append(bullet)
            self.can_shoot = False
            self.shoot_timer = SHOOT_DELAY

        if not self.can_shoot:
            self.shoot_timer -= delta_time
            if self.shoot_timer <= 0:
                self.can_shoot = True

        bullets_to_remove = []
        for bullet in self.bullets:
            bullet.update()
            if bullet.y > SCREEN_HEIGHT + 20:
                bullets_to_remove.append(bullet)
        for bullet in bullets_to_remove:
            if bullet in self.bullets:
                self.bullets.remove(bullet)

        spawn_chance = 0.02 + self.level * 0.005
        if random.random() < spawn_chance:
            asteroid = Asteroid(
                random.uniform(50, SCREEN_WIDTH - 50),
                SCREEN_HEIGHT + 50,
                random.uniform(30, 60),
                random.uniform(-2, 2),
                random.uniform(-4, -2)
            )
            self.asteroids.append(asteroid)

        asteroids_to_remove = []
        for asteroid in self.asteroids:
            asteroid.update()

            if asteroid.y < -100:
                asteroids_to_remove.append(asteroid)
                continue

            if self.player_invulnerable <= 0:
                if asteroid.collides_with(self.player_x, self.player_y, self.player_width // 2):
                    self.player_health -= 20
                    self.player_invulnerable = 60
                    asteroids_to_remove.append(asteroid)

                    for _ in range(10):
                        particle = Particle(
                            asteroid.x,
                            asteroid.y,
                            random.uniform(-3, 3),
                            random.uniform(-3, 3),
                            random.uniform(2, 5),
                            (255, 50, 50),
                            0.7
                        )
                        self.particles.append(particle)

            bullets_to_remove = []
            for bullet in self.bullets:
                if asteroid.collides_with(bullet.x, bullet.y, 3):
                    bullets_to_remove.append(bullet)
                    asteroid.health -= 1

                    if asteroid.health <= 0:
                        self.score += 10
                        self.asteroids_destroyed += 1
                        asteroids_to_remove.append(asteroid)

                        for _ in range(15):
                            particle = Particle(
                                asteroid.x,
                                asteroid.y,
                                random.uniform(-4, 4),
                                random.uniform(-4, 4),
                                random.uniform(3, 6),
                                (255, 165, 0),
                                1.0
                            )
                            self.particles.append(particle)

            for bullet in bullets_to_remove:
                if bullet in self.bullets:
                    self.bullets.remove(bullet)

        for asteroid in asteroids_to_remove:
            if asteroid in self.asteroids:
                self.asteroids.remove(asteroid)

        particles_to_remove = []
        for particle in self.particles:
            particle.update(delta_time)
            if not particle.is_alive():
                particles_to_remove.append(particle)
        for particle in particles_to_remove:
            if particle in self.particles:
                self.particles.remove(particle)

        self.level = 1 + int(self.game_time // 30)

        if self.player_health <= 0:
            self.game_state = "GAME_OVER"
            self.save_high_score()


    def on_key_press(self, key, modifiers):
        if self.game_state == "MENU":
            if key == arcade.key.SPACE or key == arcade.key.ENTER:
                self.start_game()
            elif key == arcade.key.ESCAPE:
                arcade.close_window()

        elif self.game_state == "PLAYING":
            if key == arcade.key.LEFT:
                self.left_pressed = True
            elif key == arcade.key.RIGHT:
                self.right_pressed = True
            elif key == arcade.key.SPACE:
                self.space_pressed = True
            elif key == arcade.key.ESCAPE:
                self.game_state = "MENU"
                self.setup()

        elif self.game_state == "GAME_OVER":
            if key == arcade.key.R:
                self.start_game()
            elif key == arcade.key.ESCAPE:
                self.game_state = "MENU"
                self.setup()


    def on_key_release(self, key, modifiers):
        if self.game_state == "PLAYING":
            if key == arcade.key.LEFT:
                self.left_pressed = False
            elif key == arcade.key.RIGHT:
                self.right_pressed = False
            elif key == arcade.key.SPACE:
                self.space_pressed = False


    def on_mouse_press(self, x, y, button, modifiers):
        if button == arcade.MOUSE_BUTTON_LEFT:
            if self.game_state == "MENU":
                if (SCREEN_WIDTH // 2 - 100 <= x <= SCREEN_WIDTH // 2 + 100 and
                    150 <= y <= 200):
                    self.start_game()

            elif self.game_state == "GAME_OVER":
                if (SCREEN_WIDTH // 2 - 100 <= x <= SCREEN_WIDTH // 2 + 100 and
                    150 <= y <= 200):
                    self.start_game()
                elif (SCREEN_WIDTH // 2 - 100 <= x <= SCREEN_WIDTH // 2 + 100 and
                      100 <= y <= 150):
                    self.game_state = "MENU"
                    self.setup()


def main():
    print("=" * 50)
    print("КОСМИЧЕСКИЙ ЗАЩИТНИК")
    print("=" * 50)
    print("Управление:")
    print("1. В меню: нажмите на кнопку или ПРОБЕЛ для начала")
    print("2. Игра: ← → для движения, ПРОБЕЛ для стрельбы")
    print("3. ESC для выхода в меню")
    print("4. В конце игры: R - новая игра, ESC - в меню")
    print("=" * 50)

    game = SpaceDefender()
    game.setup()
    arcade.run()


if __name__ == "__main__":
    main()
